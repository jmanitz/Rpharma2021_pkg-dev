---
title: "Building Tidy R Packages"
author: "Leigh Alexander | Juliane Manitz"
date: "R/Pharma workshop | October 27, 2021"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      countIncrementalSlides: no
      highlightStyle: github
      titleSlideClass:
       - right
       - bottom
    self_contained: no
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
#options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(message = FALSE, warning = FALSE, cache = FALSE, 
                      error = TRUE, dev = "cairo_pdf", fig.retina = 2)

library(devtools)
library(usethis)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
#?style_mono_accent

style_mono_accent(
  base_color = "#1c5253", 
  inverse_text_color = "#cbf7ed",
  link_color = "orange"
)

style_extra_css(
  css = list(
    ".inverse h4" = list(color = "orange"),
    ".title-slide h1" = list(color = "orange")
  ))
```

```{css, include=FALSE}
/* custom.css */
.big-left {
  width: 60%;
  height: 92%;
  float: left;
}
.small-right {
  width: 37%;
  float: right;
  padding-left: 1%;
}

.small-left {
  width: 40%;
  height: 92%;
  float: left;
}
.big-right {
  width: 57%;
  float: right;
  padding-left: 1%;
}
.remark-code {
  font-size: 24px;
}
.small .remark-code { /*Change made here*/
  font-size: 80% !important;
}
.tiny .remark-code { /*Change made here*/
  font-size: 50% !important;
}
```

class:inverse
# Workshop Description

**Why make an R package?** So many reasons! From sharing code and collaboration, to reproducibility and regulatory concerns, and finally for organizing you own analysis projects and tidy coding practices, R packages are here to help!

In this workshop, we will cover the very first steps of R package creation, the basic R package structure as well as all relevant components. 

-	Start to write R functions, 
-	document them with help pages, 
-	integrate examples and data, 
-	make sure that your code does what is expected by implementing unit testing, and 
-	finally build it and put it on CRAN or wherever you want to share it. 

We conclude the workshop with a selection of advanced topics related to R packages (e.g., package validation, objected-oriented programming/S3 methods or advanced package documentation with `pkgdown`). 

**Requirements:** This workshop requires some experience with R and is targeted at beginner to intermediate R users

---
# Introductions: Who are we? 

---
# Introductions

.pull-left[
- Senior Bioinformatics Data Scientist @ SomaLogic
- Lead, Model Infrastructure team
- co-organizer, R-Ladies-Boulder
- @exuberantleigh
]

.pull-right[
add content about Juliane
]

---
# Introductions: Who are you? 

1. Experience with R: ranges [beginner <intermediate < advanced]

2. Experience with R Package development: ranges [novice < some experience]

3. Which topics are you most interested (choose 3)? 
  - Basic Package Structure
  - Tools for R packaging
  - Unit testing
  - Advanced Documentation 
  - Package validation, 
  - Object orientated programming in R

4. What to you wanna use package development for? 
  - Personal use, 
  - internal company-use, 
  - make it publicly available

---
# What is Tidy? <img src="media/tidyverse.png" class="title-hex", width="100px", align="right">

[Tidy Manifesto](https://tidyverse.tidyverse.org/articles/manifesto.html)

### There are four basic principles to a tidy API:
.pull-left[
What they say:
1. Reuse existing data structures.
2. Compose simple functions with the pipe.
3. Embrace functional programming.
4. Design for humans.
]

.pull-right[
What that means:
1. Dataframes and vector are your friends!
2. Keep your functions simple - do one thing and do it well.
3. Write (and use) functions, change your life!
4. Make it easy to read, understand, and use (tab complete)
]

---
class: inverse, middle, center
# Why would I want to make a package?
*"Anything that can by automated, should be automated."*  
Hadley Wickham & Jenny Bryan   

---
# Sharing code

* Streamlines and standardizes code across teams/labs/collaborators
* Reduces duplicative efforts
* Highly portable
* Easier to specify relative paths
* "It works on my machine"

---
# Tools that enable reproducibility and testing

.center[
*"Packages are the fundamental units of reproducible R code."*  
HW & JB
]

* Unit tests
* Dependency management
* R version/package version management

---
# Reusing my own functions

## Rule of threes

* If you copy and paste code 3 times, make it a function
* If you re-use a function 3 times, make it a package

---
# Analysis project

* Put an end to source("path/to/my/file")!
* Use wrapper functions to create same plots across scripts/RMarkdown files
    + multiple chapters in one document
    + move from html, to Word, to Powerpoint

---
class: inverse
# Resources

.pull-left[
## Package Dev
- [r-pkg-book](https://r-pkgs.org/)  
- [usethis](https://usethis.r-lib.org/)  
- [usethis-workflow](https://www.hvitfeldt.me/blog/usethis-workflow-for-package-development/)  
- [tidyverse-dev](https://usethis.r-lib.org/reference/tidyverse.html)  
- [examples-on-github-forcats](https://github.com/tidyverse/forcats)  
]

.pull-right[
## Writing functions
- [r-4-data-science](https://r4ds.had.co.nz/functions.html)  
- [advanced-r](https://adv-r.hadley.nz/functions.html)  
]

---
class: center, middle, inverse
# Package Structure

---
# Basic Package Structure

.pull-left[
- Code
  - \R
  - \tests
- Documentation
  - \man
  - \vignettes
- Package Guts
  - DESCRIPTION
  - NAMESPACE
]

.pull-right[
![Package Directory](media/pkg-overview.png)
]

---
# /R directory

<img src="media/r-dir.png" class="title-hex", width="400px", align="right", padding-left:5%>
- Where your functions live!
- Rules of thumb:
  - Either one function per file  
  **or**  
    A family of related functions  
   
- Includes individual `?function` documentation via [roxygen](https://roxygen2.r-lib.org/) comments

---
# Tidy Style

pull-left[
- Naming of functions is important
  - verbs
  - tab complete
  - common prefixes
]

pull-right[
include pic of family of functions
]

---
# DESCRIPTION
<img src="media/description-ex.png" class="title-hex", width="300px", align="right", padding-left:5%>
- "Package metadata"
- Required  

#### What other functions/packages does your packages need?
- **Imports: I need this package (or function from this package) to work**
  - Installed, but not attached
  - Best Practice: use `package::function` in your code to access seamlessly
  
- **Suggests: You can do a lot more cool stuff with my package, if you have this package**
  - Not installed with your package
  - Useful for external functions used in vignettes, testing, examples
  - Nice way to reduce dependency nightmares



---
# NAMESPACE

.pull-left[
- Confusing, but part of what makes R packages highly portable
- Determined by your `roxygen` comments in the R function files
]

.pull-right[
![DESCRIPTION example](media/namespace-ex.png)
]

--- 
# NAMESPACE
.pull-left[
- Imports/Exports
]

.pull-right[

]

---
# NAMESPACE

- Search path

---
# /data vs /data-raw

.pull-left[
#### data
- Exported data that is "lazy loaded"
- Cleaned versions of data
- `usethis::use_data()` to save `.rdata` file
]
.pull-right[
#### data-raw
- .rds, .csv, or any data file
- .R script that does the cleaning/manipulation
- add to `.RBuildignore`
]


---
# `devtools` and `usethis`

.pull-left[
knitr::
[devtools](https://devtools.r-lib.org/)
]
<img src="media/usethis.png" class="title-hex", width="100px", align="right", padding-left:5%>
---
class: inverse, middle, center
# Let's make a package!

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package do? 

- *R/* - Start to write R functions, 

- *data/* - integrate examples and data, 

- *man/* - document them with help pages, 

- *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- finally build it and put it on CRAN or wherever you want to share it. 

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package? 

- #### R/ - Start to write R functions, 

- *data/* - integrate examples and data, 

- *man/* - document them with help pages, 

- *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- finally built it and put it on CRAN or wherever you want to share it. 

---
# Write R functions

- `R/` directory contains all R code
- A package with just an `R/` directory is still a very useful package.

--

### Good practice to structure:

- each function in a separate file (good for small packages)
- everything in one file (ok for small packages)
- group related functions in a file with meaningful names (best solution for larger projects)

---
# Workflow to Integrate R code

1. Edit your code.
2. Load your code with one of `devtools::load_all()`, which re-loads all saved files in `R/` into memory.
3. Experiment in the console.
4. Repeat

*Tip*: Ctrl/Cmd + Shift + L (keyboard shortcut) saves all open files then calls `load_all()`.

---
# Toy Example

The standard structure can be obtained automatically using `package.skeleton()`:

```{r, echo=TRUE}
# define some basic functions
add <- function(x, y){ x + y }
plusone <- function(x){ x + 1 }

# test your source code
add(10, 1)
plusone(4)
```

```{r eval=FALSE}
create_package("../example/myutils")
usethis::use_r(add, plusone)
```

???
```{r, eval=FALSE}
# create standard structure
fdlist <- c("add","plusone","dat")
utils::package.skeleton("../example/myutils", fdlist, force=TRUE)
```

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package? 

- *R/* - Start to write R functions, 

- #### data/ - integrate examples and data, 

- *man/* - document them with help pages, 

- *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- finally built it and put it on CRAN or wherever you want to share it. 

---
# Package Example Data 

- The `data/` directory allows you to include data with your package.
- distribute 
- If `DESCRIPTION` contains `LazyData: true`, then the datasets won't occupy any memory until you use them

### Store data in

- `data/` to make data available to package users
- `R/sysdata.rda` to keep data internal for use by your functions.
- `inst/extdata` to make raw data available for loading and parsing examples. Access this data with `system.file()`

???

- Always use LazyData: true in your DESCRIPTION file.
- Store data in one of data/, R/Sysdata.rda, inst/extdata

---
# Workflow to Integrate Datasets

- Save data as `.Rdata` files in `data/`, which can be created by `save()`

- Make sure to adhere rules by using `devtools::use_data()`, which adds a data object to `data/` 

- data object gets added to `R/Sysdata.rda` if `internal = TRUE`

- `devtools::use_data_raw()` adds an R Script used to clean a data set to `data-raw/` and includes `data-raw/` on `.Rbuildignore`.

???

- Save data as .Rdata files (suggested)
- compress data to optimal value using option in `use_data()`

---
# Toy Example

The standard structure can be obtained automatically using `package.skeleton()`:

```{r, echo=TRUE}

# test your source code
add(10, 1)
plusone(4)

# prepare some example data
dat <- data.frame(id=1:10, x=rpois(10, 5), y=rpois(10, 5))

x <- 1
y <- 2
use_data(x, y)

# create standard structure
fdlist <- c("add","plusone","dat")
utils::package.skeleton("../example/myutils", fdlist, force=TRUE)
```

???

``` {r}
# test your source code
add(10, 1)
plusone(4)
dat 
```

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package? 

- *R/* - Start to write R functions, 

- *data/* - integrate examples and data, 

- #### *man/* - document them with help pages, 

- *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- finally built it and put it on CRAN or wherever you want to share it. 

---
# R Function Documentation

- `man/` contains the documentation for your functions, the help pages in your package.
- R documentation format is very LaTeX-like output (LaTeX installation required)

.small[
```{r, eval=FALSE, echo=TRUE, size="small"}
\name{add}
\alias{add}
\title{Add together two numbers}
\usage{ add(x, y) }
\arguments{
  \item{x}{A number}
  \item{y}{A number}
}
\value{
  The sum of \code{x} and \code{y}
}
\description{ Add together two numbers }
\examples{
  add(1, 1)
  add(10, 1)
}
```
]

---
# Documentation with roxygen

- The `roxygen2` package lets you write documentation inline in your R-files
- `devtools` implements `roxygen2` to make documentation. 

### Workflow

1. Add roxygen comments in your `.R` files
2. Convert roxygen comments into documentation with `devtools::document()` which converts roxygen comments to `.Rd` files, places them in `man/.` and builds `NAMESPACE`.
3. Open help pages with `?` to preview documentation
4. Repeat

???

Ctrl/Cmd + Shift + D (Keyboard Shortcut)

---
# Documentation with roxygen

- roxygen comments start with `#'`
- Place comment lines directly above the code that defines the object documented.
- tags like `@param`, `@return`, `@author` define specific sections in `.Rd` file
- Untagged lines will be used to generate a title, description, and details section (in that order)

.small[
```{r, eval=FALSE, echo=TRUE}
#' Add together two numbers.
#'
#' @param x A number.
#' @param y A number.
#' @return The sum of \code{x} and \code{y}.
#' @examples
#' add(1, 1)
#' @export
add <- function(x, y) {
 x + y
}
```
]

???

---
# R help

!! integrate picture

---
# NAMESPACE

- The `NAMESPACE` file helps you make your package self-contained: it won’t interfere with other packages, and other packages won’t interfere with it.
- although the `NAMESPACE` file looks like R code, it is not processed as R code
- specifies which variables in the package should be **exported** to make them available to package users, and which variables
should be **imported** from other packages

``` {r eval=FALSE}
# import all functions from packages foo and bar
import(foo, bar) 
# import selected functions f and g from foo
importFrom(foo, f, g) 
# export functions f and g
export(f, g) 
```

---
# Create the NAMESPACE using roxygen 

- Export functions for users by placing `@export` in the roxygen comments
- Import objects from other packages with `package::object` (recommended) or 
- `@import`/`@importFrom`

--

### Workflow

1. Modify your code 
2. Document your package, e.g. using `devtools::document()`
3. Check `NAMESPACE`
4. Repeat until `NAMESPACE` is correct

???

- roxygen tags like `@includes`, `@export`, `@importFrom` generate `NAMESPACE` und `Collate`

- for packages with many variables to export it may be more convenient to specify the names to export with a regular expression
```{r}
#exportPattern("\^{}[\^{}\textbackslash\textbackslash.]")
```

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package? 

- *R/* - Start to write R functions, 

- *data/* - integrate examples and data, 

- *man/* - document them with help pages, 

- #### *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- finally built it and put it on CRAN or wherever you want to share it. 

---
# Testing

"A unit testing system designed to be fun, exible and easy to set up." (Wickham)

- Provides functions that make it easy to describe what you expect a function to do, including catching errors, warnings
and messages.

- Displays test progress visually, showing a pass, fail or error for
every expectation. If you're using the terminal, it'll even
colour the output.

```{r echo=TRUE, eval=FALSE}
library(testthat)
library(yourpackage)

test_check("yourpackage")
```

---
# Testing

- `expect_that` describes expected result of your code (value, class, correct error message, computation time, etc.)
- `test_that` is grouping a number of expectation's for one functions or a feature
- `context()` is grouping a number of content-related tests

```{r echo=TRUE, eval=FALSE}
require(testthat)
test_that("trigonometric functions match identities", {
expect_that(sin(pi / 4), equals(1 / sqrt(2)))
expect_that(cos(pi / 4), equals(1 / sqrt(2)))
expect_that(tan(pi / 4), equals(1))
})
```

testthat: Hadley Wickham (2011). testthat: Get Started with Testing. The R Journal 3(1).

---
class: inverse
# Workshop Outline: Part II

Basic R package components: 

- *DESCRIPTION* - What does the package? 

- *R/* - Start to write R functions, 

- *data/* - integrate examples and data, 

- *man/* - document them with help pages, 

- *tests/* - make sure that your code does what is expected by implementing unit testing, and 

- #### finally built it and put it on CRAN or wherever you want to share it. 

---
# Building an R Package

For building a R package pkg run the following commands in your
console:

- `R CMD SHLIB pkg` compiles C/C++/Fortran code in pkg/src

- `R CMD build pkg` generates package bundle `pkg.tar.gz` or `pkg.zip`

- `R CMD INSTALL pkg.tar.gz` installs package

- `R CMD check pkg.tar.gz` runs CRAN validity checks (is pkg valid?)

**Note!** In windows, installation of `Rtools` is required.

---
#Example: Build and Check myutils

.small[
``` {r, eval=FALSE, echo=TRUE}
jmanitz@console$ R CMD build myutils_complete
* checking for file `myutils_complete/DESCRIPTION' ... OK
* preparing `myutils':
* checking DESCRIPTION meta-information ... OK
* installing the package to process help pages
* [...]
* building `myutils_1.0.tar.gz'

jmanitz@console$ R CMD check myutils_1.0.tar.gz
* using log directory `/home/Rladies/example/myutils.Rcheck'
* using R version 3.5.2 (2018-12-20)
* using platform: x86_64-pc-linux-gnu (64-bit)
* checking for file `myutils/DESCRIPTION' ... OK
* [...]
* checking PDF version of manual ... OK
* DONE
Status: OK
```
]

---
# R Packaging using `devtools`

- `load all()` simulates installing and reloading your package
--


- `document()` updates documentation, file collation and NAMESPACE.
--


- `check doc()` runs most of the documentation checking components of R CMD check
--


- `run_examples()` will run all examples to make sure they work.
--


- `test()` reloads your code, then runs all testthat tests.
--


- `check()` updates the documentation, then builds and checks the package
--


- `build()`, `build_win()` builds a package file from package sources (only one R version)

???
R functions from `devtools` that simplify R packaging:


---
# Other Package Elements

Standard structure

- `DESCRIPTION` what does the package? who can use it (license)? who is responsible (maintainer)?
- `NAMESPACE` which function should be seen by the user? which are internal?
- `R/` Write R functions
- `man/` documentation, help files with syntax similar to LATEX
- `data/` example data files
- `tests/` tests

Additional (optional) files in R packages:

- `vignettes/` vignette
- `doc/` pkgdown
- `inst/CITATION` how should the user cite the package?
- `src/` C, C++, FORTRAN source code

---
class: inverse
# Workshop Description: Part III

[...]

We conclude the workshop with a selection of advanced topics related to R packages (e.g., package validation, objected-oriented programming/S3 methods or advanced package documentation with `pkgdown`). 

--

1. Advanced package documentation 

2. Package validation 

3. Objected-oriented programming with S3 methods 

---
class: inverse
# Advanced Documentation [Leigh]

5 slides = 10mins

---
# Advanced Documentation

- vignettes
- websites

---
# Vignettes

- A vignette is a long-form guide to your package like a book chapter or an academic paper. 

- When writing a vignette, you’re teaching someone how to use your package.

- Data for vignettes: If you want to show how to work with an already loaded dataset, put that data in data/. If you want to show how to load raw data, put that data in inst/extdata. 

???

Function documentation is great if you know the name of the function you need, but it’s useless otherwise.

---
# pkgdown

- websites, 

---
class: inverse
# Package validation [Juliane]

(topic introduction: 3 slides + references)
5-10mins

---


---
class: inverse
# Object-Oriented Progamming (OOP) [Leigh/Juliane]

10slides 20min

---
# Object-Oriented Progamming 

- In Object-Oriented Progamming (OOP), computer programs are designed by making them out of objects that interact with one another

- a class defines the behaviour of objects by describing their attributes and their relationship to other classes.

- the class is also used when selecting methods, functions that behave differently depending on the class of their input.
- R has three OO systems: S3, S4, Reference classes, and the system of base types

---
# Picking an OOP System in R

- majority of object-oriented code that I have written in R is S3

- S3 is the simplest and most commonly used OO system.
    - suffcient for fairly simple objects and methods 
    - no formal definition of classes. 

- S4/Reference classes may be more appropriate for more complicated systems of interrelated objects

- follow good examples from other packages: 

   - for S4 is the [`Matrix`](http://Matrix.R-forge.R-project.org/) package by Douglas Bates and Martin Maechler

  - for an example of Encapsulated References Classes see the [`dplyr`](https://dplyr.tidyverse.org/) package by RStudio
  
- Other OO systems are used, e.g. [`ggplot2`](https://ggplot2.tidyverse.org) package uses the the `ggproto` system, which is mostly a [historical accident](https://cloud.r-project.org/web/packages/ggplot2/vignettes/extending-ggplot2.html)

???

R6: Encapsulated Classes with Reference Semantics
Creates classes with reference semantics, similar to R's built-in reference classes. Compared to reference classes, R6 classes are simpler and lighter-weight, and they are not built on S4 classes so they do not require the methods package. These classes allow public and private members, and they support inheritance, even when the classes are defined in different packages.

---
# Object-Oriented Progamming (OOP) using S3

- simple objects and methods 

- computations are carried out via methods, a special type of function called a generic function decides which method to call,

for pre-existing generic functions like `print()`, `summary()`, and `plot()`
    

- roxygen tags like `@method`, `@importClassesFrom`, `@importMethodsFrom` are used for for OOP documentation


